# Provider Caching Refactor Review (2025-10-10)

## Blocking issues
- DeepGEMM still runs when no model is supplied. `.devcontainer/tools/sgl_admin.py:766` dispatches the DeepGEMM stage whenever `--deep-gemm != skip`, even if `model=None`. The generated command forwards `--model ''` to the compile script, which now treats `--model` as required. In the default CLI flow (`populate_caches.sh` â†’ `sgl_admin caches ensure`), this yields an immediate failure when someone forgets `--model`, and the rest of the prep workflow never runs. We should either make `--model` mandatory or auto-skip every cache stage that needs a model when the argument is missing.
- FlashInfer log symlink recreation breaks if the old layout left a real directory behind. `.devcontainer/tools/sgl_admin.py:200-208` calls `Path.unlink()` on whatever currently lives at `~/.cache/flashinfer/90a`. Python raises `IsADirectoryError` when that path is a directory, so users that ever ran the previous tooling (which created a directory) will now see "Failed to recreate FlashInfer JIT symlink" and the command aborts. We should detect directories and remove/rename them before creating the symlink.
- DeepGEMM compile server is left running on error paths. `python/sglang/compile_deep_gemm.py:81-108` raises on readiness timeout or on the warm-up POST without ever killing the spawned `sglang.launch_server` process. On failure we leave a bound port 30000 server behind, and any retry will hang on `_pick_warmup_port_require_30000`. Wrap the body in `try/finally` so we terminate the child whenever we raise.
- DeepGEMM compile logs no longer capture server output. `_start_server_cli()` pipes both stdout and stderr to `subprocess.DEVNULL` (`python/sglang/compile_deep_gemm.py:55-60`), so the `compile.log` that `sgl_admin.py` tails never contains the actual failure traces from `launch_server`. Debugging is almost impossible now. We should redirect the child process output into the same log stream that the wrapper prints (or at least to a file).
- DeepGEMM compile CLI cannot enable remote code. `_build_compile_cli_args()` hard-codes a minimal argument list (`python/sglang/compile_deep_gemm.py:33-50`) and drops `--trust-remote-code`. Many of the target HF models (DeepSeek, DBRX, etc.) require it to load. At the moment every compile attempt against those repos fails before we even hit the readiness loop.

## High severity
- New config defaults are not actually wired in. We now ship `.devcontainer/tools/sglang-config.json`, but `sgl_admin.py` still hard-codes `mem_fraction`, `chunked_prefill_size`, `context_length`, and related server knobs (`.devcontainer/tools/sgl_admin.py:706-843`). Changes to the JSON are silently ignored, which defeats the goal of centralising defaults. We should read those values from `_load_sglang_config()` before we rely on them.
- Warm-up and lock timers from `caching-config.json` are only used for DeepGEMM (`.devcontainer/tools/sgl_admin.py:805-823`). FlashInfer, Inductor, and MoE still use hard-coded 300s/none paths even though the config file exposes `warmup_timeout_s` and `lock_timeout_s`. The JSON will mislead operators unless we honor those fields.
- Default config path assumes `/workspaces/sglang`. `_load_caching_config()` and `_load_sglang_config()` pick that absolute path when the env-var overrides are unset (`.devcontainer/tools/sgl_admin.py:15-42`). Running the CLI directly on the host (or inside any container that mounts the repo somewhere else) now crashes even though the config files are co-located with the script. Falling back to `Path(__file__).parent` would make the tool usable outside the devcontainer workflow.

## Medium severity & polish
- `_normalize_moe_batch_spec()` returns `(mode="default", values=None)` for empty input, but later we record that as `"all"` in the run metadata (`.devcontainer/tools/sgl_admin.py:728-739`). Consider preserving an explicit "default" marker so downstream tooling can tell the difference between "user asked for all" and "we just used the script defaults".
- `scripts/cache/populate_caches.sh` now shells into the relocated admin script. The quoting via `${args[*]@Q}` works on Bash 4.4+, but if we ever need POSIX shell compatibility the helper will break. Document the Bash requirement (or fall back to `printf %q`).
- `.devcontainer/tools/__pycache__/sgl_admin.cpython-310.pyc` is generated locally and should stay out of the repo; a quick `.gitignore` entry would prevent accidental commits.

## Follow-ups / questions
- Do we still plan to support per-stage locks for MoE? The config JSON exposes `moe.lock_timeout_s`, but `sgl_admin.py` never calls `_acquire_lock()` for that stage.
- Should we capture different defaults for GH200 vs. A100? If the intent is to move everything to JSON, we may want to split config files per hardware profile or add schema constraints.
- The DeepGEMM signature still hard-codes `kv_cache_dtype`, `chunked_prefill_size`, etc., which means the compile signature only stays in sync if we manually modify two files. Once we trust the JSON, we should derive the signature there as well to keep drift under control.
